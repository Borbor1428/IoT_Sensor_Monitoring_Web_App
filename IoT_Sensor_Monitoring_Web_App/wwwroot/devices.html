<!DOCTYPE html>
<html lang="en">
<head>
    <script>
        // Navbar'da aktif sayfayı işaretle
        (function () {
            const path = window.location.pathname.toLowerCase();
            const dashLink = document.getElementById("nav-dashboard");
            const devLink = document.getElementById("nav-devices");

            if (!dashLink || !devLink) return;

            if (path.includes("dashboard")) {
                dashLink.classList.add("active");
            } else if (path.includes("devices")) {
                devLink.classList.add("active");
            }
        })();
    </script>

    <meta charset="UTF-8">
    <title>Device & Sensor Registration</title>
    <style>
        /* NAVBAR */
        .navbar {
            background: #111827;
            color: #f9fafb;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            margin: -20px -20px 20px -20px; /* sayfanın üst paddingini sıfırlamak için */
        }

        .navbar-brand {
            font-weight: 600;
            font-size: 18px;
        }

        .navbar-links {
            display: flex;
            gap: 16px;
        }

            .navbar-links a {
                color: #e5e7eb;
                text-decoration: none;
                font-size: 14px;
                padding: 6px 10px;
                border-radius: 999px;
            }

                .navbar-links a:hover {
                    background: #1f2937;
                }

                .navbar-links a.active {
                    background: #2563eb;
                    color: #f9fafb;
                }

        body {
            font-family: Arial, sans-serif;
            background: #f4f5f7;
            padding: 20px;
        }

        h1, h2, h3 {
            margin-top: 0;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-top: 8px;
            font-size: 13px;
        }

        input, select {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            margin-top: 2px;
            font-size: 13px;
        }

        button {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #2563eb;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

            button:hover {
                background: #1d4ed8;
            }

        .status {
            font-size: 12px;
            margin-top: 8px;
            color: #6b7280;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            text-align: left;
        }

        th {
            background: #f9fafb;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-brand">IoT Sensor Monitoring</div>
        <div class="navbar-links">
            <a href="/dashboard.html" id="nav-dashboard">Dashboard</a>
            <a href="/devices.html" id="nav-devices">Devices</a>
        </div>
    </div>

    <div class="container">
        <!-- senin mevcut içeriklerin (cards, charts vs) bu container içinde kalsın -->

        <div class="container">
            <h1>Device & Sensor Registration</h1>

            <div class="row">
                <!-- SADECE DEVICE KAYDI -->
                <div class="card">
                    <h2>Register Device</h2>

                    <label for="deviceName">Device Name</label>
                    <input type="text" id="deviceName" placeholder="e.g. Lab Node 1" />

                    <label for="deviceLocation">Location</label>
                    <input type="text" id="deviceLocation" placeholder="e.g. Room 101" />

                    <!-- Metric Type -->
                    <label for="deviceMetricType">Metric Type</label>
                    <select id="deviceMetricType">
                        <option value="Temperature">Temperature</option>
                        <option value="Humidity">Humidity</option>
                        <option value="Pressure">Pressure</option>
                        <option value="AirQuality">AirQuality</option>
                    </select>

                    <!-- Unit (metric'e göre otomatik dolacak) -->
                    <label for="deviceUnit">Unit</label>
                    <select id="deviceUnit"></select>

                    <!-- Interval -->
                    <label for="deviceInterval">Reading Interval (seconds)</label>
                    <input type="number" id="deviceInterval" value="5" min="1" />

                    <button id="btnAddDevice">Create Device</button>
                    <div class="status" id="deviceStatus"></div>
                </div>

                <!-- KÜÇÜK AÇIKLAMA KARTI -->
                <div class="card">
                    <h2>Info</h2>
                    <p style="font-size:13px;">
                        Her cihaz, seçilen <strong>Metric Type</strong>'a göre tek bir sensörle oluşturulur:
                    </p>
                    <ul style="font-size:13px;">
                        <li><strong>Temperature</strong> → Sıcaklık Sensörü (°C veya °F)</li>
                        <li><strong>Humidity</strong> → Nem Sensörü (%)</li>
                        <li><strong>Pressure</strong> → Basınç Sensörü (hPa veya bar)</li>
                        <li><strong>AirQuality</strong> → Hava Kalitesi Sensörü (ppm veya AQI)</li>
                    </ul>
                    <p style="font-size:13px;">
                        <strong>Reading Interval</strong> cihazın ne sıklıkla veri üreteceğini belirler
                        (örneğin her 5 saniyede bir, 10 saniyede bir).
                    </p>
                </div>
            </div>

            <!-- DEVICES TABLE -->
            <div class="card">
                <h2>Devices</h2>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Type (Metric)</th>
                            <th>Location</th>
                            <th>Interval (s)</th>
                            <th>Active</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <tr><td colspan="6">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- İSTEĞE BAĞLI EK SENSOR -->
            <div class="card">
                <h2>Register Additional Sensor</h2>

                <label for="sensorDeviceSelect">Device</label>
                <select id="sensorDeviceSelect"></select>

                <label for="sensorName">Sensor Name</label>
                <input type="text" id="sensorName" placeholder="e.g. Extra Temperature Sensor" />

                <label for="metricType">Metric Type</label>
                <input type="text" id="metricType" placeholder="e.g. Temperature, Humidity" />

                <label for="unit">Unit</label>
                <input type="text" id="unit" placeholder="e.g. °C, %, hPa, ppm" />

                <button id="btnAddSensor">Create Sensor</button>
                <div class="status" id="sensorStatus"></div>
            </div>
        </div>

        <script>
            const deviceTableBody = document.getElementById("deviceTableBody");
            const deviceStatusEl = document.getElementById("deviceStatus");
            const sensorDeviceSelectEl = document.getElementById("sensorDeviceSelect");
            const sensorStatusEl = document.getElementById("sensorStatus");

            const metricTypeSelect = document.getElementById("deviceMetricType");
            const unitSelect = document.getElementById("deviceUnit");

            // Metric -> Unit mapping
            function refreshUnitOptions() {
                const metric = metricTypeSelect.value;
                unitSelect.innerHTML = "";

                let units = [];

                if (metric === "Temperature") {
                    units = ["°C", "°F"];
                } else if (metric === "Humidity") {
                    units = ["%"];
                } else if (metric === "Pressure") {
                    units = ["hPa", "bar"];
                } else if (metric === "AirQuality") {
                    units = ["ppm", "AQI"];
                }

                units.forEach(u => {
                    const opt = document.createElement("option");
                    opt.value = u;
                    opt.textContent = u;
                    unitSelect.appendChild(opt);
                });
            }

            metricTypeSelect.addEventListener("change", refreshUnitOptions);
            // Sayfa ilk açıldığında default doldur
            refreshUnitOptions();

            // Metric'e göre DeviceTypeId bulan veya oluşturan helper
            async function getDeviceTypeIdForMetric(metric) {
                // Tüm device type'ları çek
                const res = await fetch("/api/devicetypes");
                let types = [];
                if (res.ok) {
                    types = await res.json();
                }

                // İsim eşleşmesine göre ara (typeName = metric)
                let found = types.find(t => t.typeName === metric);
                if (found) return found.deviceTypeId;

                // Yoksa otomatik oluştur (örn. "Temperature")
                const createRes = await fetch("/api/devicetypes", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ typeName: metric })
                });

                if (!createRes.ok) {
                    throw new Error("Error creating device type for metric: " + metric);
                }

                const created = await createRes.json();
                return created.deviceTypeId;
            }

            async function loadDevices() {
                const res = await fetch("/api/devices");
                if (!res.ok) {
                    deviceTableBody.innerHTML = `
                            <tr><td colspan="6">Error loading devices.</td></tr>
                        `;
                    return;
                }

                const devices = await res.json();

                deviceTableBody.innerHTML = "";
                sensorDeviceSelectEl.innerHTML = "";

                if (devices.length === 0) {
                    deviceTableBody.innerHTML = `
                            <tr><td colspan="6">No devices yet.</td></tr>
                        `;
                    return;
                }

                devices.forEach(d => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                            <td>${d.deviceId}</td>
                            <td>${d.deviceName}</td>
                            <td>${d.deviceType ? d.deviceType.typeName : ""}</td>
                            <td>${d.location || ""}</td>
                            <td>${d.readingIntervalSeconds || 0}</td>
                            <td>${d.isActive ? "Yes" : "No"}</td>
                        `;
                    deviceTableBody.appendChild(tr);

                    const opt = document.createElement("option");
                    opt.value = d.deviceId;
                    opt.textContent = `${d.deviceName} (#${d.deviceId})`;
                    sensorDeviceSelectEl.appendChild(opt);
                });
            }

            // Device + ana sensor ekleme
            document.getElementById("btnAddDevice").addEventListener("click", async () => {
                const name = document.getElementById("deviceName").value.trim();
                const location = document.getElementById("deviceLocation").value.trim();
                const interval = parseInt(document.getElementById("deviceInterval").value);
                const metricType = metricTypeSelect.value;
                const unit = unitSelect.value;

                if (!name) {
                    deviceStatusEl.textContent = "Device name is required.";
                    return;
                }
                if (!interval || interval <= 0) {
                    deviceStatusEl.textContent = "Reading interval must be a positive number.";
                    return;
                }

                try {
                    // 1) Metric'e uygun DeviceTypeId'yi bul/oluştur
                    const typeId = await getDeviceTypeIdForMetric(metricType);

                    // 2) Cihazı oluştur
                    const deviceRes = await fetch("/api/devices", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            deviceName: name,
                            deviceTypeId: typeId,
                            location: location,
                            isActive: true,
                            createdAt: new Date().toISOString(),
                            readingIntervalSeconds: interval
                        })
                    });

                    if (!deviceRes.ok) {
                        deviceStatusEl.textContent = "Error creating device.";
                        return;
                    }

                    const createdDevice = await deviceRes.json();

                    // 3) Cihaz için sensör oluştur (seçilen metric + unit ile)
                    const sensorRes = await fetch("/api/sensors", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            deviceId: createdDevice.deviceId,
                            sensorName: metricType + " Sensor",
                            metricType: metricType,
                            unit: unit,
                            isActive: true
                        })
                    });

                    if (sensorRes.ok) {
                        deviceStatusEl.textContent = "Device and sensor created.";
                        document.getElementById("deviceName").value = "";
                        document.getElementById("deviceLocation").value = "";
                        document.getElementById("deviceInterval").value = "5";
                        await loadDevices();
                    } else {
                        deviceStatusEl.textContent = "Device created but error creating sensor.";
                    }
                } catch (err) {
                    console.error(err);
                    deviceStatusEl.textContent = "Error while creating device type/device.";
                }
            });

            // Ek sensör ekleme (isteğe bağlı)
            document.getElementById("btnAddSensor").addEventListener("click", async () => {
                const deviceId = parseInt(sensorDeviceSelectEl.value);
                const name = document.getElementById("sensorName").value.trim();
                const metricType = document.getElementById("metricType").value.trim();
                const unit = document.getElementById("unit").value.trim();

                if (!deviceId || !name || !metricType) {
                    sensorStatusEl.textContent = "Device, sensor name and metric type are required.";
                    return;
                }

                const res = await fetch("/api/sensors", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        deviceId: deviceId,
                        sensorName: name,
                        metricType: metricType,
                        unit: unit,
                        isActive: true
                    })
                });

                if (res.ok) {
                    sensorStatusEl.textContent = "Sensor created.";
                    document.getElementById("sensorName").value = "";
                    document.getElementById("metricType").value = "";
                    document.getElementById("unit").value = "";
                } else {
                    sensorStatusEl.textContent = "Error creating sensor.";
                }
            });

            // Sayfa açıldığında mevcut cihazları yükle
            (async () => {
                await loadDevices();
            })();
        </script>

</body>
</html>
