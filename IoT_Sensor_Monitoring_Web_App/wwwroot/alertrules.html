<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alert Rules</title>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        /* ---- SOL SIDEBAR ---- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 230px;
            height: 100vh;
            background: #020617;
            color: #e5e7eb;
            padding-top: 24px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1f2937;
            z-index: 999;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            padding: 0 20px 18px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: #6b7280;
            padding: 0 20px 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar a {
            padding: 10px 20px;
            font-size: 14px;
            text-decoration: none;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid transparent;
            transition: background 0.2s, border-left 0.2s, color 0.2s;
        }

            .sidebar a span.icon {
                width: 18px;
            }

            .sidebar a:hover {
                background: #020617;
                color: #e5e7eb;
            }

            .sidebar a.active {
                background: linear-gradient(90deg, #0f172a, #020617);
                border-left: 3px solid #38bdf8;
                color: #f9fafb;
            }

        /* ---- ANA İÇERİK ---- */
        .main-content {
            margin-left: 230px;
            min-height: 100vh;
            padding: 22px 26px 30px;
            background: radial-gradient(circle at top left, #1d2537 0, #020617 55%);
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 180px;
            }

            .main-content {
                margin-left: 180px;
            }
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .title-block h1 {
            margin: 0;
            font-size: 22px;
            color: #f9fafb;
        }

        .title-block small {
            color: #9ca3af;
            font-size: 12px;
        }

        .muted-small {
            color: #64748b;
            font-size: 11px;
        }

        .card {
            border-radius: 14px;
            padding: 16px 18px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
            margin-bottom: 18px;
        }

        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
        }

        .card-title {
            margin: 0;
            font-size: 15px;
            color: #e5e7eb;
        }

        .card-sub {
            margin: 0;
            font-size: 12px;
            color: #9ca3af;
        }

        label {
            display: block;
            margin-top: 10px;
            font-size: 13px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            margin-top: 4px;
            padding: 7px 9px;
            border-radius: 8px;
            border: 1px solid rgba(148,163,184,0.6);
            font-size: 13px;
            background: #020617;
            color: #e5e7eb;
        }

            input:focus, select:focus {
                outline: none;
                border-color: #38bdf8;
                box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
            }

        button {
            margin-top: 14px;
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            background: #38bdf8;
            color: #0b1120;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

            button:hover {
                background: #0ea5e9;
            }

        .status-msg {
            margin-top: 8px;
            font-size: 12px;
            color: #9ca3af;
        }

        /* tablo */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }

        thead {
            background: rgba(15,23,42,0.96);
        }

        th, td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(55,65,81,0.8);
            text-align: left;
        }

        th {
            font-weight: 500;
            color: #9ca3af;
        }

        tbody tr:hover {
            background: rgba(30,64,175,0.25);
        }

        .tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
        }

            .tag.on {
                background: rgba(34,197,94,0.18);
                color: #bbf7d0;
            }

            .tag.off {
                background: rgba(148,163,184,0.18);
                color: #e5e7eb;
            }

        .badge-metric {
            display: inline-flex;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(56,189,248,0.16);
            color: #e0f2fe;
        }

        .pill-cond {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(248, 250, 252, 0.06);
            color: #e5e7eb;
        }

        .grid {
            display: grid;
            gap: 18px;
            grid-template-columns: 1.3fr 1.1fr;
        }

        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- SOL NAVBAR -->
    <div class="sidebar">
        <div class="sidebar-title">IoT Monitoring</div>
        <div class="sidebar-subtitle">Navigation</div>
        <a href="/dashboard.html" id="nav-dashboard">
            <span class="icon">📊</span><span>Dashboard</span>
        </a>
        <a href="/devices.html" id="nav-devices">
            <span class="icon">🔧</span><span>Devices</span>
        </a>
        <a href="/alertrules.html" id="nav-alerts">
            <span class="icon">⚠</span><span>Alert Rules</span>
        </a>
        <a href="/retention.html" id="nav-retention">
            <span class="icon">🗑</span><span>Retention</span>
        </a>
        <a href="/sensor-detail.html" id="nav-sensor-detail">
            <span class="icon"></span><span>sensor detail</span>
        </a>
    </div>

    <!-- ANA İÇERİK -->
    <div class="main-content">
        <div class="top-bar">
            <div class="title-block">
                <h1>Alert Rules</h1>
                <small>Eşik değeri kuralları ile otomatik uyarı üretimi</small>
            </div>
        </div>

        <div class="grid">
            <!-- Alert rule formu -->
            <div class="card">
                <div class="card-header-row">
                    <div>
                        <p class="card-title">Create Alert Rule</p>
                        <p class="card-sub">Sensör, koşul ve eşik değerini seç.</p>
                    </div>
                </div>

                <label for="sensorSelect">Sensor</label>
                <select id="sensorSelect">
                    <option value="">Loading sensors...</option>
                </select>

                <label for="conditionType">Condition</label>
                <select id="conditionType">
                    <option value="Above">Above (>)</option>
                    <option value="Below">Below (&lt;)</option>
                </select>

                <label for="thresholdValue">Threshold Value</label>
                <input id="thresholdValue" type="number" step="0.01" />

                <label for="message">Alert Message</label>
                <input id="message" type="text" placeholder="e.g. Temperature too high" />

                <button id="btnCreateRule">Create Rule</button>
                <div class="status-msg" id="ruleStatus"></div>
            </div>

           

        <!-- Kurallar tablosu -->
        <div class="card">
            <div class="card-header-row">
                <div>
                    <p class="card-title">Existing Rules</p>
                    <p class="card-sub">Tanımlanmış tüm uyarı kuralları</p>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Sensor</th>
                        <th>Condition</th>
                        <th>Threshold</th>
                        <th>Message</th>
                        <th>Active</th>
                    </tr>
                </thead>
                <tbody id="rulesTableBody">
                    <tr><td colspan="6" class="muted-small">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // sidebar active
        (function () {
            const p = window.location.pathname.toLowerCase();
            if (p.includes("dashboard")) document.getElementById("nav-dashboard").classList.add("active");
            if (p.includes("devices")) document.getElementById("nav-devices").classList.add("active");
            if (p.includes("alertrules")) document.getElementById("nav-alerts").classList.add("active");
            if (p.includes("retention")) document.getElementById("nav-retention").classList.add("active");
            if (p.includes("sensor-detail")) document.getElementById("nav-sensor-detail").classList.add("active");
        })();

        const sensorSelect = document.getElementById("sensorSelect");
        const conditionSelect = document.getElementById("conditionType");
        const thresholdInput = document.getElementById("thresholdValue");
        const messageInput = document.getElementById("message");
        const ruleStatus = document.getElementById("ruleStatus");
        const rulesTableBody = document.getElementById("rulesTableBody");

        async function loadSensors() {
            try {
                const res = await fetch("/api/sensors");
                if (!res.ok) throw new Error("Failed to load sensors");

                const sensors = await res.json();
                if (!sensors || sensors.length === 0) {
                    sensorSelect.innerHTML = '<option value="">No sensors available</option>';
                    return;
                }

                sensorSelect.innerHTML = "";
                for (const s of sensors) {
                    const opt = document.createElement("option");
                    opt.value = s.sensorId;
                    const metric = s.metricType || "";
                    const unit = s.unit || "";
                    opt.textContent = `${s.sensorId} - ${s.sensorName} (${metric} ${unit})`;
                    sensorSelect.appendChild(opt);
                }
            } catch (e) {
                console.error(e);
                sensorSelect.innerHTML = '<option value="">Error loading sensors</option>';
            }
        }

        async function loadRules() {
            rulesTableBody.innerHTML = '<tr><td colspan="6" class="muted-small">Loading...</td></tr>';
            try {
                const res = await fetch("/api/alertrules");
                if (!res.ok) throw new Error("Failed to load rules");

                const rules = await res.json();
                if (!rules || rules.length === 0) {
                    rulesTableBody.innerHTML =
                        '<tr><td colspan="6" class="muted-small">No alert rules defined yet.</td></tr>';
                    return;
                }

                rulesTableBody.innerHTML = "";
                for (const r of rules) {
                    const tr = document.createElement("tr");

                    const sensorName = r.sensor?.sensorName || `Sensor ${r.sensorId}`;
                    const metric = r.sensor?.metricType || "";
                    const unit = r.sensor?.unit || "";

                    tr.innerHTML = `
                            <td>${r.alertRuleId}</td>
                            <td>
                                ${sensorName}
                                <div class="muted-small">
                                    <span class="badge-metric">${metric} ${unit}</span>
                                </div>
                            </td>
                            <td>
                                <span class="pill-cond">
                                    ${r.conditionType === "Above" ? "Above (>)" : "Below (<)"}
                                </span>
                            </td>
                            <td>${r.thresholdValue}</td>
                            <td>${r.message}</td>
                            <td>
                                <span class="tag ${r.isActive ? "on" : "off"}">
                                    ${r.isActive ? "Active" : "Inactive"}
                                </span>
                            </td>
                        `;

                    rulesTableBody.appendChild(tr);
                }
            } catch (e) {
                console.error(e);
                rulesTableBody.innerHTML =
                    '<tr><td colspan="6" class="muted-small">Error loading rules.</td></tr>';
            }
        }

        document.getElementById("btnCreateRule").addEventListener("click", async () => {
            const sensorId = parseInt(sensorSelect.value);
            const condition = conditionSelect.value;
            const threshold = parseFloat(thresholdInput.value);
            const msg = messageInput.value.trim();

            if (!sensorId) {
                ruleStatus.textContent = "Please select a sensor.";
                return;
            }
            if (!Number.isFinite(threshold)) {
                ruleStatus.textContent = "Threshold value is required.";
                return;
            }
            if (!msg) {
                ruleStatus.textContent = "Message is required.";
                return;
            }

            ruleStatus.textContent = "Saving...";

            try {
                const res = await fetch("/api/alertrules", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sensorId: sensorId,
                        conditionType: condition,
                        thresholdValue: threshold,
                        message: msg,
                        isActive: true
                    })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    console.error(txt);
                    ruleStatus.textContent = "Error while creating rule.";
                    return;
                }

                ruleStatus.textContent = "Rule created successfully.";
                thresholdInput.value = "";
                messageInput.value = "";
                await loadRules();
            } catch (e) {
                console.error(e);
                ruleStatus.textContent = "Error while creating rule.";
            }
        });

        // ilk yükleme
        loadSensors();
        loadRules();
    </script>
</body>
</html>
