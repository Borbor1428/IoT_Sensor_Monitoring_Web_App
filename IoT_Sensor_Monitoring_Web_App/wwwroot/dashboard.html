<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>IoT Sensor Monitoring Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a; /* koyu arka plan */
            color: #e5e7eb;
        }

        /* ---- SOL DİKEY SIDEBAR ---- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 230px;
            height: 100vh;
            background: #020617;
            color: #e5e7eb;
            padding-top: 24px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #1f2937;
            z-index: 999;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            padding: 0 20px 18px;
        }

        .sidebar-subtitle {
            font-size: 11px;
            color: #6b7280;
            padding: 0 20px 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .sidebar a {
            padding: 10px 20px;
            font-size: 14px;
            text-decoration: none;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 8px;
            border-left: 3px solid transparent;
            transition: background 0.2s, border-left 0.2s, color 0.2s;
        }

            .sidebar a span.icon {
                width: 18px;
            }

            .sidebar a:hover {
                background: #020617;
                color: #e5e7eb;
            }

            .sidebar a.active {
                background: linear-gradient(90deg, #0f172a, #020617);
                border-left: 3px solid #38bdf8;
                color: #f9fafb;
            }

        /* ---- ANA İÇERİK ---- */
        .main-content {
            margin-left: 230px;
            min-height: 100vh;
            padding: 22px 26px 30px;
            background: radial-gradient(circle at top left, #1d2537 0, #020617 55%);
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 180px;
            }

            .main-content {
                margin-left: 180px;
            }
        }

        /* Üst header bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .title-block h1 {
            margin: 0;
            font-size: 22px;
            color: #f9fafb;
        }

        .title-block small {
            color: #9ca3af;
            font-size: 12px;
        }

        .status-pill {
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.3);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #9ca3af;
        }

        .status-pill.connected {
            background: rgba(34,197,94,0.12);
            color: #bbf7d0;
        }

            .status-pill.connected .status-dot {
                background: #22c55e;
            }

        .status-pill.disconnected {
            background: rgba(220,38,38,0.18);
            color: #fecaca;
        }

            .status-pill.disconnected .status-dot {
                background: #ef4444;
            }

        /* Grid layout */
        .grid {
            display: grid;
            gap: 18px;
        }

        .grid-3 {
            grid-template-columns: 2.1fr 1.3fr;
        }

        .grid-2 {
            grid-template-columns: 2fr 1.2fr;
        }

        @media (max-width: 1000px) {
            .grid-3, .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .card {
            border-radius: 14px;
            padding: 16px 18px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.6);
        }

        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 8px;
        }

        .card-title {
            margin: 0;
            font-size: 15px;
            color: #e5e7eb;
        }

        .card-sub {
            margin: 0;
            font-size: 12px;
            color: #9ca3af;
        }

        /* metric chips */
        .metric-row {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .metric-box {
            flex: 1 1 160px;
            border-radius: 10px;
            padding: 10px 11px;
            background: radial-gradient(circle at top, rgba(56,189,248,0.22), transparent 55%);
            border: 1px solid rgba(148,163,184,0.3);
        }

        .metric-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9ca3af;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 600;
            margin-top: 3px;
            color: #e5e7eb;
        }

        .metric-secondary {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .sensor-select {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #cbd5f5;
        }

        label {
            font-size: 13px;
        }

        select {
            padding: 6px 9px;
            border-radius: 8px;
            border: 1px solid rgba(148,163,184,0.6);
            font-size: 13px;
            background: #020617;
            color: #e5e7eb;
        }

            select:focus {
                outline: none;
                border-color: #38bdf8;
                box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
            }

        /* Chart */
        .chart-wrapper {
            border-radius: 12px;
            background: radial-gradient(circle at top, rgba(56,189,248,0.18), rgba(15,23,42,0.9));
            border: 1px solid rgba(148,163,184,0.2);
            padding: 10px 12px 6px;
        }

        /* Alerts */
        .alerts-list {
            max-height: 380px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .alert-item {
            border-radius: 10px;
            padding: 9px 11px;
            margin-bottom: 8px;
            background: rgba(248, 113, 113, 0.08);
            border: 1px solid rgba(248,113,113,0.5);
            font-size: 13px;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .alert-sensor {
            font-weight: 600;
            color: #fecaca;
        }

        .alert-time {
            font-size: 11px;
            color: #9ca3af;
        }

        .alert-message {
            font-size: 13px;
            color: #e5e7eb;
        }

        .alert-details {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 3px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 7px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(248, 113, 113, 0.18);
            color: #fecaca;
            margin-left: 6px;
        }

        .muted {
            color: #64748b;
            font-size: 12px;
            margin-top: 4px;
        }

        .muted-small {
            color: #64748b;
            font-size: 11px;
        }
    </style>
</head>
<body>

    <!-- SOL DİKEY NAVBAR -->
    <div class="sidebar">
        <div class="sidebar-title">IoT Monitoring</div>
        <div class="sidebar-subtitle">Navigation</div>
        <a href="/dashboard.html" id="nav-dashboard">
            <span class="icon">📊</span>
            <span>Dashboard</span>
        </a>
        <a href="/devices.html" id="nav-devices">
            <span class="icon">🔧</span>
            <span>Devices</span>
        </a>
        <a href="/alertrules.html" id="nav-alerts">
            <span class="icon">⚠</span>
            <span>Alert Rules</span>
        </a>
        <a href="/retention.html" id="nav-retention">
            <span class="icon">🗑</span>
            <span>Retention</span>
        </a>
        <a href="/sensor-detail.html" id="nav-sensor-detail">
            <span class="icon"></span><span>sensor detail</span>
        </a>
    </div>

    <!-- ANA İÇERİK -->
    <div class="main-content">
        <div class="top-bar">
            <div class="title-block">
                <h1>Real-Time Sensor Dashboard</h1>
                <small>Simüle edilmiş IoT verileri ile canlı izleme</small>
            </div>
            <div class="status-pill" id="connectionStatus">
                <span class="status-dot"></span>
                <span>Connecting...</span>
            </div>
        </div>

        <!-- ÜST GRID: Current Sensor + System Info -->
        <div class="grid grid-3">
            <!-- Current sensor -->
            <div class="card">
                <div class="card-header-row">
                    <div>
                        <p class="card-title">Current Sensor</p>
                        <p class="card-sub">Seçili sensör için en son okunan değer</p>
                    </div>
                </div>

                <div class="metric-row">
                    <div class="metric-box">
                        <div class="metric-label">Sensor</div>
                        <div class="metric-value" id="sensorNameValue">-</div>
                        <div class="metric-secondary" id="sensorMetricType">-</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Latest Value</div>
                        <div class="metric-value" id="latestValue">-</div>
                        <div class="metric-secondary" id="latestUnit">-</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Last Updated</div>
                        <div class="metric-value" id="lastUpdated">-</div>
                        <div class="metric-secondary" id="lastUpdatedLocal">-</div>
                    </div>
                </div>

                <div class="sensor-select">
                    <label for="sensorSelect">Sensor seç:</label>
                    <select id="sensorSelect">
                        <option value="">(ilk gelen sensör otomatik seçilir)</option>
                    </select>
                </div>
            </div>

            <!-- System info -->
            <div class="card">
                <div class="card-header-row">
                    <div>
                        <p class="card-title">System Overview</p>
                        <p class="card-sub">Görülen sensör sayısı ve son uyarı</p>
                    </div>
                </div>

                <div class="metric-row" style="margin-top:10px;">
                    <div class="metric-box">
                        <div class="metric-label">Total Sensors Seen</div>
                        <div class="metric-value" id="totalSensors">0</div>
                        <div class="metric-secondary">En az bir kez veri göndermiş sensörler</div>
                    </div>
                </div>
                <div class="metric-row">
                    <div class="metric-box" style="flex:1 1 100%;">
                        <div class="metric-label">Last Alert</div>
                        <div class="metric-value" id="lastAlertShort">-</div>
                        <div class="metric-secondary" id="lastAlertTime">-</div>
                    </div>
                </div>

                <p class="muted" style="margin-top:10px;">
                    Data source: <strong>FakeSensorBackgroundService</strong> &amp; SignalR hub
                    ile gerçek zamanlı yayın.
                </p>
            </div>
        </div>

        <!-- ALT GRID: Chart + Alerts -->
        <div class="grid grid-2" style="margin-top:18px;">
            <!-- Chart -->
            <div class="card">
                <div class="card-header-row" style="margin-bottom:6px;">
                    <div>
                        <p class="card-title">Real-Time Chart</p>
                        <p class="card-sub">Seçili sensörün son değerleri</p>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <canvas id="chart" height="190"></canvas>
                </div>
            </div>

            <!-- Alerts -->
            <div class="card">
                <div class="card-header-row">
                    <div>
                        <p class="card-title">Active Alerts</p>
                        <p class="card-sub">Eşik değerlerini aşan son okumalar</p>
                    </div>
                </div>
                <div class="alerts-list" id="alertsList">
                    <div class="muted">Henüz bir uyarı yok.</div>
                </div>
                <p class="muted-small" style="margin-top:6px;">
                    Kırmızı kartlar <strong>AlertRules</strong> sayfasında tanımladığın kurallara göre üretilir.
                </p>
            </div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById("connectionStatus");
        const sensorNameEl = document.getElementById("sensorNameValue");
        const sensorMetricTypeEl = document.getElementById("sensorMetricType");
        const latestValueEl = document.getElementById("latestValue");
        const latestUnitEl = document.getElementById("latestUnit");
        const lastUpdatedEl = document.getElementById("lastUpdated");
        const lastUpdatedLocalEl = document.getElementById("lastUpdatedLocal");
        const sensorSelectEl = document.getElementById("sensorSelect");
        const totalSensorsEl = document.getElementById("totalSensors");
        const alertsListEl = document.getElementById("alertsList");
        const lastAlertShortEl = document.getElementById("lastAlertShort");
        const lastAlertTimeEl = document.getElementById("lastAlertTime");

        // sensorId -> { name, unit, metricType, labels:[], values:[] }
        const sensorData = {};
        let currentSensorId = null;

        const ctx = document.getElementById("chart").getContext("2d");
        const chart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [{
                    label: "Sensor Value",
                    data: [],
                    borderWidth: 2,
                    borderColor: "rgba(56,189,248,0.9)",
                    backgroundColor: "rgba(56,189,248,0.12)",
                    tension: 0.25,
                    pointRadius: 3,
                    pointHoverRadius: 4
                }]
            },
            options: {
                animation: false,
                responsive: true,
                plugins: { legend: { labels: { color: "#e5e7eb" } } },
                scales: {
                    x: {
                        ticks: { maxTicksLimit: 6, color: "#9ca3af" },
                        grid: { color: "rgba(148,163,184,0.1)" }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: "#9ca3af" },
                        grid: { color: "rgba(148,163,184,0.15)" }
                    }
                }
            }
        });

        sensorSelectEl.addEventListener("change", () => {
            const selected = sensorSelectEl.value;
            if (!selected) return;
            currentSensorId = parseInt(selected);
            refreshChartForCurrentSensor();
            refreshSelectedSensorInfo();
        });

        function refreshChartForCurrentSensor() {
            if (!currentSensorId || !sensorData[currentSensorId]) {
                chart.data.labels = [];
                chart.data.datasets[0].data = [];
                chart.update();
                return;
            }
            const data = sensorData[currentSensorId];
            chart.data.labels = [...data.labels];
            chart.data.datasets[0].data = [...data.values];
            chart.update();
        }

        function refreshSelectedSensorInfo() {
            if (!currentSensorId || !sensorData[currentSensorId]) {
                sensorNameEl.textContent = "-";
                sensorMetricTypeEl.textContent = "-";
                return;
            }
            const data = sensorData[currentSensorId];
            sensorNameEl.textContent = data.name;
            sensorMetricTypeEl.textContent = data.metricType + " (" + data.unit + ")";
        }

        function updateTotals() {
            totalSensorsEl.textContent = Object.keys(sensorData).length.toString();
        }

        function formatUtc(iso) {
            try {
                const d = new Date(iso);
                return d.toISOString().replace("T", " ").substring(0, 19) + " UTC";
            } catch { return iso; }
        }

        function formatLocal(iso) {
            try {
                const d = new Date(iso);
                return d.toLocaleString();
            } catch { return iso; }
        }

        function addAlertToList(alert) {
            if (alertsListEl.children.length === 1 &&
                alertsListEl.firstElementChild.classList.contains("muted")) {
                alertsListEl.innerHTML = "";
            }

            const div = document.createElement("div");
            div.className = "alert-item";

            const header = document.createElement("div");
            header.className = "alert-header";

            const left = document.createElement("div");
            left.className = "alert-sensor";
            left.textContent = alert.sensorName || ("Sensor " + alert.sensorId);

            const pill = document.createElement("span");
            pill.className = "pill";
            pill.textContent = alert.conditionType + " " + alert.thresholdValue;
            left.appendChild(pill);

            const right = document.createElement("div");
            right.className = "alert-time";
            right.textContent = formatLocal(alert.triggeredAt);

            header.appendChild(left);
            header.appendChild(right);

            const msg = document.createElement("div");
            msg.className = "alert-message";
            msg.textContent = alert.message || "Alert triggered";

            const details = document.createElement("div");
            details.className = "alert-details";
            details.textContent = "Value: " + alert.value.toFixed(2);

            div.appendChild(header);
            div.appendChild(msg);
            div.appendChild(details);

            alertsListEl.prepend(div);

            lastAlertShortEl.textContent =
                (alert.sensorName || ("Sensor " + alert.sensorId)) +
                " (" + alert.conditionType + " " + alert.thresholdValue + ")";
            lastAlertTimeEl.textContent = formatLocal(alert.triggeredAt);
        }

        async function startConnection() {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/hubs/sensor")
                .withAutomaticReconnect()
                .build();

            connection.onreconnecting(() => {
                statusEl.classList.remove("connected");
                statusEl.classList.add("disconnected");
                statusEl.lastElementChild.textContent = "Reconnecting...";
            });

            connection.onreconnected(() => {
                statusEl.classList.remove("disconnected");
                statusEl.classList.add("connected");
                statusEl.lastElementChild.textContent = "Connected";
            });

            connection.onclose(() => {
                statusEl.classList.remove("connected");
                statusEl.classList.add("disconnected");
                statusEl.lastElementChild.textContent = "Disconnected";
            });

            connection.on("ReceiveReading", (reading) => {
                const id = reading.sensorId;
                if (!sensorData[id]) {
                    sensorData[id] = {
                        name: reading.sensorName || ("Sensor " + id),
                        unit: reading.unit || "",
                        metricType: reading.metricType || "",
                        labels: [],
                        values: []
                    };

                    const opt = document.createElement("option");
                    opt.value = id;
                    opt.textContent = sensorData[id].name;
                    sensorSelectEl.appendChild(opt);

                    if (!currentSensorId) {
                        currentSensorId = id;
                        sensorSelectEl.value = id;
                    }

                    updateTotals();
                    refreshSelectedSensorInfo();
                }

                const data = sensorData[id];
                const label = new Date().toLocaleTimeString();
                data.labels.push(label);
                data.values.push(reading.value);

                if (data.labels.length > 30) {
                    data.labels.shift();
                    data.values.shift();
                }

                if (currentSensorId === id) {
                    chart.data.labels = [...data.labels];
                    chart.data.datasets[0].data = [...data.values];
                    chart.update();

                    latestValueEl.textContent = reading.value.toFixed(2);
                    latestUnitEl.textContent = reading.unit || "";
                    lastUpdatedEl.textContent = formatUtc(reading.recordedAt);
                    lastUpdatedLocalEl.textContent = formatLocal(reading.recordedAt);
                } else {
                    lastUpdatedEl.textContent = formatUtc(reading.recordedAt);
                    lastUpdatedLocalEl.textContent = formatLocal(reading.recordedAt);
                }
            });

            connection.on("ReceiveAlert", (alert) => {
                addAlertToList(alert);
            });

            try {
                await connection.start();
                statusEl.classList.add("connected");
                statusEl.lastElementChild.textContent = "Connected";
            } catch (err) {
                console.error(err);
                statusEl.classList.add("disconnected");
                statusEl.lastElementChild.textContent = "Failed to connect";
            }
        }

        startConnection();

        // Sidebar active link
        (function () {
            const p = window.location.pathname.toLowerCase();
            if (p.includes("dashboard")) document.getElementById("nav-dashboard").classList.add("active");
            if (p.includes("devices")) document.getElementById("nav-devices").classList.add("active");
            if (p.includes("alertrules")) document.getElementById("nav-alerts").classList.add("active");
            if (p.includes("retention")) document.getElementById("nav-retention").classList.add("active");
            if (p.includes("sensor-detail")) document.getElementById("nav-sensor-detail").classList.add("active");
        })();
    </script>

</body>
</html>